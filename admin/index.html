<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration SAV | Car Parts France</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="admin.css">
    <link rel="stylesheet" href="kanban.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="admin-container">
        <header class="admin-header">
            <div class="logo">
                <h1>Car Parts France</h1>
                <span>Administration SAV</span>
            </div>
            <div class="horizontal-nav">
                <nav>
                    <ul>
                        <li class="active"><a href="#tickets"><i class="fas fa-ticket-alt"></i> Tickets</a></li>
                        <li><a href="#orders"><i class="fas fa-shopping-cart"></i> Commandes</a></li>
                        <li><a href="#docs"><i class="fas fa-book"></i> Documentation</a></li>
                        <li><a href="#settings"><i class="fas fa-cog"></i> Paramètres</a></li>
                    </ul>
                </nav>
            </div>
            <div class="user-info">
                <span id="admin-name">Admin</span>
                <button id="notif-btn" class="btn-notifs" aria-label="Notifications">
                    <i class="fas fa-bell"></i>
                    <span id="notif-badge" class="notif-badge"></span>
                </button>
                <div id="notif-dropdown" class="notif-dropdown" aria-label="Liste des notifications" hidden>
                    <div class="notif-dropdown-header">
                        <span>Notifications</span>
                        <button id="notif-mark-all" class="link-btn" title="Tout marquer comme lu">Tout marquer comme lu</button>
                    </div>
                    <div id="notif-list" class="notif-list"></div>
                    <div id="notif-empty" class="notif-empty" hidden>Aucune notification</div>
                </div>
                <button id="logout-btn" class="btn-logout"><i class="fas fa-sign-out-alt"></i> Déconnexion</button>
            </div>
        </header>
        
        <div class="admin-content">
            
            <main class="admin-main">
                <div class="admin-login" id="admin-login">
                    <div class="login-container">
                        <h2>Connexion Administration</h2>
                        <form id="login-form">
                            <div class="form-group">
                                <label for="username">Nom d'utilisateur</label>
                                <input type="text" id="username" required>
                            </div>
                            <div class="form-group">
                                <label for="password">Mot de passe</label>
                                <input type="password" id="password" required>
                            </div>
                            <div class="form-group">
                                <button type="submit" class="btn-primary">Se connecter</button>
                            </div>
                            <div class="login-error" id="login-error"></div>
                        </form>
                        <div class="forgot-block" style="margin-top:10px;">
                            <a href="#" id="forgot-password-link">Mot de passe oublié ?</a>
                            <form id="forgot-form" style="display:none; margin-top:10px;">
                                <div class="form-group">
                                    <label for="forgot-email">Votre email</label>
                                    <input type="email" id="forgot-email" required>
                                </div>
                                <button type="submit" class="btn-secondary">Recevoir le lien de réinitialisation</button>
                                <div id="forgot-msg" class="login-error" style="display:none;"></div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div class="admin-dashboard" id="admin-dashboard" style="display: none;">
                    <div class="dashboard-layout">
                        <!-- Volet latéral des filtres (à gauche) -->
                        <div class="filters-sidebar" id="filters-sidebar">
                            <div class="filters-sidebar-header">
                                <h3><i class="fas fa-filter"></i> Filtres</h3>
                                <button id="toggle-filters-sidebar" class="toggle-filters-btn" title="Masquer/Afficher les filtres">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                            </div>
                            
                            <div class="filters-sidebar-content">
                                <!-- Recherche globale -->
                                <div class="search-container">
                                    <input type="text" id="search-input" placeholder="Recherche globale...">
                                    <button id="search-btn" aria-label="Rechercher"><i class="fas fa-search"></i></button>
                                </div>
                                
                                <!-- Contenu des filtres -->
                                <div class="filter-container">
                                    <h3 id="toggle-filters"><i class="fas fa-filter"></i> Options de filtrage <span class="toggle-icon"><i class="fas fa-chevron-down"></i></span></h3>
                                    <div id="filters-content" class="filters-content">
                                    <!-- Onglets des filtres -->
                                    <div class="filter-tabs">
                                        <button class="filter-tab-btn active" data-tab="basic">Filtres de base</button>
                                        <button class="filter-tab-btn" data-tab="status">Statut & Type</button>
                                        <button class="filter-tab-btn" data-tab="client">Client & Commande</button>
                                        <button class="filter-tab-btn" data-tab="dates">Dates</button>
                                    </div>
                                    
                                    <!-- Contenu des onglets -->
                                    <div class="filter-tab-content active" id="tab-basic">
                                        <div class="filter-row">
                                            <div class="filter-group">
                                                <label for="status-filter">Statut</label>
                                                <select id="status-filter">
                                                    <option value="">Tous les statuts</option>
                                                    <option value="nouveau">Nouveau</option>
                                                    <option value="en_analyse">En analyse</option>
                                                    <option value="info_complementaire">Info complémentaire</option>
                                                    <option value="validé">Validé</option>
                                                    <option value="refusé">Refusé</option>
                                                    <option value="en_cours_traitement">En traitement</option>
                                                    <option value="expédié">Expédié</option>
                                                    <option value="clôturé">Clôturé</option>
                                                </select>
                                            </div>
                                            <div class="filter-group">
                                                <label for="part-filter">Type de pièce</label>
                                                <select id="part-filter">
                                                    <option value="">Tous les types</option>
                                                    <option value="boite_vitesses">Boîte de vitesses</option>
                                                    <option value="moteur">Moteur</option>
                                                    <option value="mecatronique">Mécatronique</option>
                                                    <option value="boite_transfert">Boîte de transfert</option>
                                                    <option value="pont">Pont</option>
                                                    <option value="autres">Autres pièces</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="filter-tab-content" id="tab-status">
                                        <div class="filter-row">
                                            <div class="filter-group">
                                                <label for="status-filter-full">Statut</label>
                                                <select id="status-filter-full">
                                                    <option value="">Tous les statuts</option>
                                                    <option value="nouveau">Nouveau</option>
                                                    <option value="en_analyse">En analyse</option>
                                                    <option value="info_complementaire">Info complémentaire</option>
                                                    <option value="validé">Validé</option>
                                                    <option value="refusé">Refusé</option>
                                                    <option value="en_cours_traitement">En traitement</option>
                                                    <option value="expédié">Expédié</option>
                                                    <option value="clôturé">Clôturé</option>
                                                </select>
                                            </div>
                                            <div class="filter-group">
                                                <label for="part-filter-full">Type de pièce</label>
                                                <select id="part-filter-full">
                                                    <option value="">Tous les types</option>
                                                    <option value="boite_vitesses">Boîte de vitesses</option>
                                                    <option value="moteur">Moteur</option>
                                                    <option value="mecatronique">Mécatronique</option>
                                                    <option value="boite_transfert">Boîte de transfert</option>
                                                    <option value="pont">Pont</option>
                                                    <option value="autres">Autres pièces</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="filter-row">
                                            <div class="filter-group">
                                                <label for="priority-filter">Priorité</label>
                                                <select id="priority-filter">
                                                    <option value="">Toutes les priorités</option>
                                                    <option value="urgent">Urgent</option>
                                                    <option value="élevé">Élevé</option>
                                                    <option value="moyen">Moyen</option>
                                                    <option value="faible">Faible</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="filter-row">
                                             <div class="filter-group">
                                                 <label class="checkbox-container" title="Afficher uniquement les tickets dont la dernière réponse provient du client et attend une action agent">
                                                     <input type="checkbox" id="awaiting-agent-filter">
                                                     <span class="checkmark"></span>
                                                     Réponse client non traitée
                                                 </label>
                                             </div>
                                         </div>
                                    </div>
                                    
                                    <div class="filter-tab-content" id="tab-client">
                                        <div class="filter-row">
                                            <div class="filter-group">
                                                <label for="ticket-number-filter">N° de ticket</label>
                                                <input type="text" id="ticket-number-filter" placeholder="Ex: SAV-12345">
                                            </div>
                                            <div class="filter-group">
                                                <label for="order-number-filter">N° de commande</label>
                                                <input type="text" id="order-number-filter" placeholder="Ex: CMD-12345">
                                            </div>
                                        </div>
                                        <div class="filter-row">
                                            <div class="filter-group">
                                                <label for="client-firstname-filter">Prénom client</label>
                                                <input type="text" id="client-firstname-filter" placeholder="Prénom">
                                            </div>
                                            <div class="filter-group">
                                                <label for="client-name-filter">Nom client</label>
                                                <input type="text" id="client-name-filter" placeholder="Nom">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="filter-tab-content" id="tab-dates">
                                        <div class="filter-row">
                                            <div class="filter-group date-filter">
                                                <label for="date-from">Date du</label>
                                                <input type="date" id="date-from">
                                            </div>
                                            <div class="filter-group date-filter">
                                                <label for="date-to">au</label>
                                                <input type="date" id="date-to">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Boutons d'action -->
                                    <div class="filter-actions">
                                        <button id="apply-filters" class="btn-primary"><i class="fas fa-check"></i> Appliquer les filtres</button>
                                        <button id="clear-filters" class="btn-secondary"><i class="fas fa-times"></i> Effacer les filtres</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Contenu principal (à droite) -->
                    <div class="dashboard-main-content">
                        <!-- Stats du dashboard -->
                        <div class="dashboard-stats">
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-ticket-alt"></i></div>
                            <div class="stat-info">
                                <h3>Total Tickets 
                                    <span class="tooltip">
                                        <i class="fas fa-info-circle info-icon"></i>
                                        <span class="tooltiptext">Nombre total de tickets SAV créés dans le système, tous statuts confondus.</span>
                                    </span>
                                </h3>
                                <p id="total-tickets">0</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-clock"></i></div>
                            <div class="stat-info">
                                <h3>En attente 
                                    <span class="tooltip">
                                        <i class="fas fa-info-circle info-icon"></i>
                                        <span class="tooltiptext">Tickets avec le statut 'en attente' qui nécessitent une action ou une décision. Inclut les nouveaux tickets et ceux en cours de traitement.</span>
                                    </span>
                                </h3>
                                <p id="pending-tickets">0</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                            <div class="stat-info">
                                <h3>Résolus 
                                    <span class="tooltip">
                                        <i class="fas fa-info-circle info-icon"></i>
                                        <span class="tooltiptext">Tickets marqués comme 'résolus' après traitement complet. Indique les demandes SAV qui ont été traitées avec succès.</span>
                                    </span>
                                </h3>
                                <p id="resolved-tickets">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="view-toggle">
                        <button id="list-view-btn" class="view-btn active"><i class="fas fa-list"></i> Vue Liste</button>
                        <button id="kanban-view-btn" class="view-btn"><i class="fas fa-columns"></i> Vue Kanban</button>
                    </div>
                    
                    <div class="tickets-list-container" id="list-view">
                        <h3>Tickets récents</h3>
                        <div class="quick-filters-bar" id="quick-filters" role="toolbar" aria-label="Filtres rapides">
                            <input type="hidden" id="sort-order-hidden" value="" />
                            <button id="qf-awaiting" class="btn-secondary" aria-pressed="false"><i class="fas fa-comment-dots"></i> En attente réponse</button>
                            <button id="qf-urgent" class="btn-secondary" aria-pressed="false"><i class="fas fa-bolt"></i> Priorité urgente</button>
                            <span></span>
                            <button id="qf-priority-asc" class="btn-secondary" aria-pressed="false" title="Trier par priorité croissante"><i class="fas fa-arrow-up-wide-short"></i> Priorité ▲</button>
                            <button id="qf-priority-desc" class="btn-secondary" aria-pressed="false" title="Trier par priorité décroissante"><i class="fas fa-arrow-down-short-wide"></i> Priorité ▼</button>
                            <span></span>
                            <button id="qf-oldest" class="btn-secondary" aria-pressed="false"><i class="fas fa-sort-amount-up"></i> Plus anciens</button>
                            <button id="qf-newest" class="btn-secondary" aria-pressed="false"><i class="fas fa-sort-amount-down"></i> Plus récents</button>
                            <button id="qf-reset" class="btn-primary"><i class="fas fa-rotate"></i> Réinitialiser</button>
                        </div>
                        <table class="tickets-table">
                            <thead>
                                <tr>
                                    <th>N° Ticket</th>
                                    <th>Client</th>
                                    <th>Type de pièce</th>
                                    <th>Date</th>
                                    <th>Priorité</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tickets-list">
                                <!-- Les tickets seront ajoutés ici dynamiquement -->
                            </tbody>
                        </table>
                        
                        <div class="pagination" id="pagination">
                            <!-- La pagination sera ajoutée ici dynamiquement -->
                        </div>
                    </div>
                    
                    <div id="kanban-view" style="display: none;">
                        <h3>Vue Kanban des tickets</h3>
                        <div class="kanban-container">
                            <div class="kanban-board">
                                <!-- Les colonnes Kanban seront générées dynamiquement -->
                            </div>
                        </div>
                    </div>
                </div>
                </div> <!-- Fin dashboard-layout -->
                </div> <!-- Fin admin-dashboard -->

                <!-- Section Commandes (top-level, séparée) -->
                <div class="admin-orders" id="admin-orders" style="display: none;">
                    <div class="settings-container">
                        <div class="breadcrumb">
                            <ul>
                                <li><a href="#"><i class="fas fa-home"></i> Dashboard</a></li>
                                <li class="active"><i class="fas fa-shopping-cart"></i> Commandes</li>
                            </ul>
                        </div>
                        <h2><i class="fas fa-shopping-cart"></i> Commandes</h2>

                        <div class="settings-actions" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                            <button id="orders-create-btn" class="btn-primary"><i class="fas fa-plus"></i> Créer une commande (brouillon)</button>
                            <button id="orders-refresh-btn" class="btn-secondary"><i class="fas fa-rotate"></i> Rafraîchir</button>
                            <button id="orders-sync-btn" class="btn-secondary"><i class="fas fa-cloud-download-alt"></i> Synchroniser (Woo+Mollie)</button>
                            <button id="orders-sync-woo-all-btn" class="btn-secondary"><i class="fas fa-database"></i> Importer toutes les commandes Woo</button>
                            <div style="flex:1; min-width:220px; display:flex; gap:8px; justify-content:flex-end;">
                                <input type="text" id="orders-search-input" placeholder="Recherche (numéro, email, SKU)" style="flex:1; min-width:220px;">
                                <select id="orders-provider-filter">
                                    <option value="">Toutes sources</option>
                                    <option value="woocommerce">WooCommerce</option>
                                    <option value="mollie">Mollie</option>
                                    <option value="bank_transfer">Virement</option>
                                    <option value="manual">Manuelle</option>
                                </select>
                                <select id="orders-status-filter">
                                    <option value="">Tous statuts</option>
                                    <option value="pending_payment">En attente paiement</option>
                                    <option value="awaiting_transfer">En attente virement</option>
                                    <option value="paid">Payée</option>
                                    <option value="processing">En préparation</option>
                                    <option value="fulfilled">Expédiée</option>
                                    <option value="cancelled">Annulée</option>
                                    <option value="failed">Échouée</option>
                                    <option value="refunded">Remboursée</option>
                                    <option value="disputed">Litige</option>
                                </select>
                            </div>
                        </div>

                        <div class="users-list-card" style="margin-top:12px;">
                            <table class="tickets-table">
                                <thead>
                                    <tr>
                                        <th>N°</th>
                                        <th>Date</th>
                                        <th>Client</th>
                                        <th>Source</th>
                                        <th>Statut</th>
                                        <th>Montant</th>
                                        <th>Activité</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="orders-list">
                                    <!-- Lignes commandes injectées ici -->
                                </tbody>
                            </table>
                            <div class="pagination" id="orders-pagination" style="margin-top:10px;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Section Paramètres - Gestion des utilisateurs SAV -->
                <div class="admin-settings" id="admin-settings">
                    <div class="settings-container">
                        <div class="breadcrumb">
                            <ul>
                                <li><a href="#"><i class="fas fa-home"></i> Dashboard</a></li>
                                <li class="active"><i class="fas fa-cog"></i> Paramètres</li>
                            </ul>
                        </div>
                        <div id="user-management-section">
                        <h2><i class="fas fa-users-cog"></i> Gestion des utilisateurs SAV</h2>
                        
                        <div class="settings-actions">
                            <button id="add-user-btn" class="btn-primary"><i class="fas fa-user-plus"></i> Ajouter un utilisateur</button>
                            <button id="refresh-users-btn" class="btn-secondary"><i class="fas fa-rotate"></i> Rafraîchir</button>
                            <span id="users-feedback" class="help-text"></span>
                        </div>
                        
                        <!-- Liste des utilisateurs -->
                        <div class="users-list-card">
                            <table class="tickets-table">
                                <thead>
                                    <tr>
                                        <th>Nom</th>
                                        <th>Email</th>
                                        <th>Rôle</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="users-list">
                                    <!-- Les utilisateurs seront ajoutés ici dynamiquement -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Formulaire d'ajout / édition d'utilisateur -->
                        <div class="user-form-card" id="user-form-card">
                            <h3 id="user-form-title"><i class="fas fa-user-edit"></i> Nouvel utilisateur</h3>
                            <form id="user-form">
                                <input type="hidden" id="user-id">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="user-firstName">Prénom</label>
                                        <input type="text" id="user-firstName" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="user-lastName">Nom</label>
                                        <input type="text" id="user-lastName" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="user-email">Email</label>
                                        <input type="email" id="user-email" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="user-role">Rôle</label>
                                        <select id="user-role" required>
                                            <option value="agent">Agent</option>
                                            <option value="admin">Admin</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="user-password">Mot de passe</label>
                                        <input type="password" id="user-password" placeholder="Min. 8 caractères">
                                        <small class="help-text">Laissez vide pour ne pas modifier le mot de passe lors d'une édition</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="user-password-confirm">Confirmer le mot de passe</label>
                                        <input type="password" id="user-password-confirm" placeholder="Retapez le mot de passe">
                                    </div>
                                    <div class="form-group inline">
                                        <label class="checkbox-container">
                                            <input type="checkbox" id="user-isActive" checked>
                                            <span class="checkmark"></span>
                                        </label>
                                        <span>Compte actif</span>
                                    </div>
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn-primary" id="save-user-btn"><i class="fas fa-save"></i> Enregistrer</button>
                                    <button type="button" class="btn-secondary" id="cancel-user-btn"><i class="fas fa-times"></i> Annuler</button>
                                </div>
                                <div id="user-form-error" class="login-error"></div>
                            </form>
                        </div>
                        </div>

                

                        <!-- Gestion des modèles de réponse -->
                        <h2><i class="fas fa-reply"></i> Modèles de réponse</h2>
                        <div class="settings-actions">
                            <button id="add-template-btn" class="btn-primary"><i class="fas fa-plus"></i> Ajouter un modèle</button>
                            <button id="refresh-templates-btn" class="btn-secondary"><i class="fas fa-rotate"></i> Rafraîchir</button>
                            <span id="templates-feedback" class="help-text"></span>
                        </div>
                        <div class="templates-list-card">
                            <table class="tickets-table">
                                <thead>
                                    <tr>
                                        <th>Libellé</th>
                                        <th>Clé</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="templates-list">
                                    <!-- Les modèles seront ajoutés ici dynamiquement -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Formulaire d'ajout / édition de modèle -->
                        <div class="template-form-card" id="template-form-card">
                            <h3 id="template-form-title"><i class="fas fa-edit"></i> Nouveau modèle</h3>
                            <form id="template-form">
                                <input type="hidden" id="template-id">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="template-key">Clé (unique)</label>
                                        <input type="text" id="template-key" placeholder="ex: ask_more_info" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="template-label">Libellé</label>
                                        <input type="text" id="template-label" placeholder="ex: Demande d'informations complémentaires" required>
                                    </div>
                                    <div class="form-group" style="grid-column: 1 / -1;">
                                        <label for="template-content">Contenu</label>
                                        <textarea id="template-content" rows="6" placeholder="Utilisez des variables: {{client.firstName}}, {{ticket.number}}, {{order.number}}" required></textarea>
                                        <small class="help-text">Variables supportées: {{client.firstName}}, {{client.lastName}}, {{ticket.number}}, {{order.number}}</small>
                                    </div>
                                    <div class="form-group inline">
                                        <label class="checkbox-container">
                                            <input type="checkbox" id="template-isActive" checked>
                                            <span class="checkmark"></span>
                                        </label>
                                        <span>Actif</span>
                                    </div>
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn-primary" id="save-template-btn"><i class="fas fa-save"></i> Enregistrer</button>
                                    <button type="button" class="btn-secondary" id="cancel-template-btn"><i class="fas fa-times"></i> Annuler</button>
                                </div>
                                <div id="template-form-error" class="login-error" style="display:none;"></div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Gestion de la documentation (édition admin) -->
                <div class="docs-admin-card" id="docs-admin-section">
                    <h2><i class="fas fa-file-alt"></i> Documentation SAV (édition admin)</h2>
                    <div class="settings-actions">
                        <button id="refresh-docs-btn" class="btn-secondary"><i class="fas fa-rotate"></i> Rafraîchir</button>
                        <button id="new-doc-btn" class="btn-secondary"><i class="fas fa-file-circle-plus"></i> Nouveau document</button>
                        <span id="docs-feedback" class="help-text"></span>
                    </div>
                    <div class="docs-editor-grid" style="display:grid; grid-template-columns: 320px 1fr; gap:16px; align-items:start;">
                        <aside class="docs-files-panel" style="border:1px solid #eee; border-radius:8px; padding:12px; background:#fff;">
                            <div class="form-group">
                                <input type="text" id="docs-filter" placeholder="Filtrer les fichiers...">
                            </div>
                            <ul id="docs-files" class="docs-files" style="list-style:none; margin:0; padding:0; max-height: 420px; overflow:auto;">
                                <!-- La liste des fichiers sera injectée ici -->
                            </ul>
                            <small class="help-text">Les fichiers sont sous <code>admin/docs/</code></small>
                        </aside>
                        <section class="docs-editor-panel" style="border:1px solid #eee; border-radius:8px; padding:12px; background:#fff;">
                            <div class="form-group">
                                <label for="docs-current-path">Chemin du fichier (.md)</label>
                                <input type="text" id="docs-current-path" placeholder="ex: guides/moteurs.md">
                                <small class="help-text">Uniquement des fichiers <code>.md</code> dans <code>admin/docs/</code></small>
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label for="docs-editor">Contenu Markdown</label>
                                <div class="docs-editor-toolbar" aria-label="Outils de mise en forme" style="display:flex; gap:6px; flex-wrap:wrap; margin:6px 0 8px; align-items:center;">
                                    <div class="toolbar-modes" role="group" aria-label="Mode d'édition" style="display:flex; gap:6px; margin-right:8px;">
                                        <button type="button" class="btn-light" id="docs-mode-visual" aria-pressed="true"><i class="fas fa-eye"></i> Visuel</button>
                                        <button type="button" class="btn-light" id="docs-mode-markdown" aria-pressed="false"><i class="fas fa-code"></i> Markdown</button>
                                    </div>
                                    <button type="button" class="btn-light" title="Gras" data-md="bold"><i class="fas fa-bold"></i></button>
                                    <button type="button" class="btn-light" title="Italique" data-md="italic"><i class="fas fa-italic"></i></button>
                                    <span style="width:1px; background:#eee; margin:0 4px;"></span>
                                    <button type="button" class="btn-light" title="Titre 1" data-md="h1">H1</button>
                                    <button type="button" class="btn-light" title="Titre 2" data-md="h2">H2</button>
                                    <button type="button" class="btn-light" title="Titre 3" data-md="h3">H3</button>
                                    <span style="width:1px; background:#eee; margin:0 4px;"></span>
                                    <button type="button" class="btn-light" title="Liste à puces" data-md="ul"><i class="fas fa-list-ul"></i></button>
                                    <button type="button" class="btn-light" title="Liste numérotée" data-md="ol"><i class="fas fa-list-ol"></i></button>
                                    <span style="width:1px; background:#eee; margin:0 4px;"></span>
                                    <button type="button" class="btn-light" title="Lien" data-md="link"><i class="fas fa-link"></i></button>
                                    <button type="button" class="btn-light" title="Code" data-md="code"><i class="fas fa-code"></i></button>
                                    <button type="button" class="btn-light" title="Citation" data-md="quote"><i class="fas fa-quote-right"></i></button>
                                </div>
                                <div id="docs-editor-wysiwyg" class="markdown-body" contenteditable="true" style="display:block; min-height:220px; border:1px solid #eaeaea; border-radius:8px; padding:12px; background:#fff; overflow:auto;" aria-label="Éditeur visuel (WYSIWYG)"></div>
                                <textarea id="docs-editor" rows="14" placeholder="# Titre\n\nVotre contenu ici..." style="display:none;"></textarea>
                            </div>
                            <div class="form-group inline" style="align-items:center; gap:8px;">
                                 <label class="checkbox-container">
                                     <input type="checkbox" id="docs-preview-toggle" checked>
                                     <span class="checkmark"></span>
                                 </label>
                                 <span>Prévisualisation en direct</span>
                             </div>
                             <div id="docs-live-preview" class="docs-preview" style="border:1px solid #eee; border-radius:8px; padding:12px; background:#fafafa; max-height: 420px; overflow:auto;">
                                 <div class="docs-content">
                                     <article class="markdown-body" id="docs-live-preview-article">
                                         <p>La prévisualisation s’affichera ici.</p>
                                     </article>
                                 </div>
                             </div>
                            <div class="form-actions">
                                <button id="save-doc-btn" class="btn-primary"><i class="fas fa-save"></i> Enregistrer</button>
                                <button id="delete-doc-btn" class="btn-danger"><i class="fas fa-trash"></i> Supprimer</button>
                            </div>
                        </section>
                    </div>
                </div>
                
                <!-- Section Documentation -->
                <div class="admin-docs" id="admin-docs" style="display: none;">
                    <div class="settings-container">
                        <div class="breadcrumb">
                            <ul>
                                <li><a href="#"><i class="fas fa-home"></i> Dashboard</a></li>
                                <li class="active"><i class="fas fa-book"></i> Documentation</li>
                            </ul>
                        </div>
                        <h2><i class="fas fa-book"></i> Aide agents SAV</h2>
                        <div class="docs-search">
                            <input type="text" id="docs-search" placeholder="Rechercher dans les documents...">
                        </div>
                        <div class="docs-layout">
                            <aside class="docs-sidebar">
                                <div id="docs-sidebar-dynamic"><!-- rempli dynamiquement --></div>
                            </aside>
                            <section class="docs-content">
                                <article id="docs-content-article">
                                    <p>Sélectionnez un document dans le menu de gauche pour l’afficher ici.</p>
                                </article>
                            </section>
                        </div>
                    </div>
                </div>
                
                <div class="ticket-details" id="ticket-details">
                    <div class="breadcrumb">
                        <ul>
                            <li><a href="#"><i class="fas fa-home"></i> Dashboard</a></li>
                            <li><a href="#" id="breadcrumb-tickets">Liste des tickets</a></li>
                            <li class="active">Détails du ticket <span id="breadcrumb-ticket-number"></span></li>
                        </ul>
                    </div>
                    
                    <div class="ticket-header">
                        <div class="ticket-header-actions">
                            <button class="btn-back" id="back-to-list"><i class="fas fa-arrow-left"></i> Retour</button>
                            <button class="btn-delete" id="delete-ticket-detail"><i class="fas fa-trash"></i> Supprimer</button>
                        <h2>Détails du ticket <span id="detail-ticket-number"></span></h2>
                        <div class="ticket-status-priority">
                            <span id="detail-ticket-priority" class="priority-badge"></span>
                            <span id="detail-ticket-status" class="ticket-current-status" style="display:none"></span>
                            <span id="detail-ticket-current-priority" style="display:none"></span>
                        </div>
                        <div class="ticket-assign-info" style="margin-top:8px; display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
                            <span><strong>Assigné à:</strong> <span id="detail-assigned-to">—</span></span>
                            <span id="detail-escalation-badge" class="priority-badge" style="display:none; background:#f59e0b; color:#111827;">Escaladé</span>
                        </div>
                        <div class="ticket-actions" id="ticket-actions" style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
                            <button id="btn-assign-ticket" class="btn-secondary" title="Assigner ce ticket"><i class="fas fa-user-check"></i> Assigner</button>
                            <button id="btn-request-assistance" class="btn-secondary" title="Demander de l'assistance interne"><i class="fas fa-life-ring"></i> Demander assistance</button>
                            <button id="btn-escalate-ticket" class="btn-danger" title="Escalader ce ticket (administrateur uniquement)"><i class="fas fa-exclamation-triangle"></i> Escalader</button>
                        </div>
                        </div>
                        
                        <!-- Bloc Informations & Notes (plein largeur au-dessus) -->
                    <div class="tabs-container">
                                <div class="tabs-nav">
                                    <button class="tab-btn active" data-tab="client"><i class="fas fa-user"></i> Client</button>
                                    <button class="tab-btn" data-tab="vehicle"><i class="fas fa-car"></i> Véhicule</button>
                                    <button class="tab-btn" data-tab="part"><i class="fas fa-cogs"></i> Pièce & Problème</button>
                                    <button class="tab-btn" data-tab="documents"><i class="fas fa-file-alt"></i> Documents</button>
                                    <button class="tab-btn" data-tab="history"><i class="fas fa-history"></i> Historique</button>
                                </div>
                                
                                <div class="tab-content active" id="tab-client">
                                    <div class="ticket-section section-info">
                                        <h3>Informations client (lecture seule)</h3>
                                        <div class="info-grid">
                                            <div class="info-item">
                                                <label>Nom</label>
                                                <p id="detail-client-name"></p>
                                            </div>
                                            <div class="info-item">
                                                <label>Email</label>
                                                <p id="detail-client-email"></p>
                                            </div>
                                            <div class="info-item">
                                                <label>Téléphone</label>
                                                <p id="detail-client-phone"></p>
                                            </div>
                                            <div class="info-item">
                                                <label>N° Commande</label>
                                                <p id="detail-order-number"></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tab-content" id="tab-vehicle">
                                    <div class="ticket-section section-info">
                                        <h3>Informations véhicule (lecture seule)</h3>
                                        <div class="info-grid">
                                            <div class="info-item">
                                                <label>VIN</label>
                                                <p id="detail-vehicle-vin"></p>
                                            </div>
                                            <div class="info-item">
                                                <label>Date d'installation</label>
                                                <p id="detail-installation-date"></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tab-content" id="tab-part">
                                    <div class="ticket-section section-info">
                                        <h3>Informations pièce et problème (lecture seule)</h3>
                                        <div class="info-grid">
                                            <div class="info-item">
                                                <label>Type de réclamation</label>
                                                <p id="detail-claim-type"></p>
                                            </div>
                                            <div class="info-item">
                                                <label>Type de pièce</label>
                                                <p id="detail-part-type"></p>
                                            </div>
                                            <div class="info-item">
                                                <label>Symptôme</label>
                                                <p id="detail-symptom"></p>
                                            </div>
                                            <div class="info-item">
                                                <label>Moment de la panne</label>
                                                <p id="detail-failure-time"></p>
                                            </div>
                                            <div class="info-item">
                                                <label>Codes défaut</label>
                                                <p id="detail-error-codes"></p>
                                            </div>
                                            <div class="info-item">
                                                <label>Installation pro</label>
                                                <p id="detail-pro-installation"></p>
                                            </div>
                                            <div class="info-item">
                                                <label>Mise en huile</label>
                                                <p id="detail-oil-filled"></p>
                                            </div>
                                            <div class="info-item">
                                                <label>Quantité huile</label>
                                                <p id="detail-oil-quantity"></p>
                                            </div>
                                            <div class="info-item">
                                                <label>Référence huile</label>
                                                <p id="detail-oil-reference"></p>
                                            </div>
                                            <div class="info-item">
                                                <label>Pièces neuves</label>
                                                <p id="detail-new-parts"></p>
                                            </div>
                                            <div class="info-item">
                                                <label>Détails pièces</label>
                                                <p id="detail-parts-details"></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tab-content" id="tab-documents">
                                    <div class="ticket-section section-info">
                                        <h3>Documents (lecture seule)</h3>
                                        <div class="documents-list" id="documents-list">
                                            <!-- Les documents seront ajoutés ici dynamiquement -->
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tab-content" id="tab-history">
                                    <div class="ticket-section section-info">
                                        <h3>Historique des statuts (lecture seule)</h3>
                                        <div class="status-timeline" id="detail-status-timeline">
                                            <!-- L'historique des statuts sera ajouté ici dynamiquement -->
                                        </div>
                                    </div>
                                </div>
                                <div class="ticket-section internal-notes">
                                    <h3>Notes internes <i class="fas fa-info-circle help-icon" title="Réservées à l'équipe interne, jamais visibles par le client"></i></h3>
                                    <p class="section-description">Ces notes sont uniquement visibles par l'équipe SAV et permettent de partager des informations confidentielles sur le dossier</p>
                                    <div class="form-group">
                                        <textarea id="internal-notes" rows="5"></textarea>
                                    </div>
                                    <div class="form-actions">
                                        <button id="save-notes" class="btn-secondary">Enregistrer les notes</button>
                                    </div>
                                </div>
                    </div>

                    <!-- Deux colonnes : Conversation (gauche) + Statut (droite) -->
                    <div class="split-view">
                        <div class="conversation-panel">
                            <div class="panel-header"><i class="fas fa-comments"></i><h3>Conversation du ticket</h3></div>
                            <div id="conversation-thread" class="conversation-thread" aria-live="polite"></div>
                        </div>
                        <div class="status-panel panel panel--status">
                            <div class="panel-header"><i class="fas fa-clipboard-check"></i><h3>Mettre à jour le statut (actions)</h3></div>
                            <form id="update-status-form">
                                <div class="form-group">
                                    <label for="new-status">Nouveau statut <i class="fas fa-info-circle help-icon" title="Modifie l'état actuel du ticket et déclenche des notifications"></i></label>
                                    <span class="current-value-indicator">Statut actuel: <span id="visible-current-status"></span></span>
                                    <small class="help-text">Ce statut sera visible par le client et indique l'étape actuelle du processus SAV</small>
                                    <select id="new-status" required>
                                        <option value="same_status">Conserver le même statut</option>
                                        <option value="">Sélectionner un statut</option>
                                        <option value="nouveau">Nouveau</option>
                                        <option value="en_analyse">En analyse</option>
                                        <option value="info_complementaire">Informations complémentaires requises</option>
                                        <option value="validé">Validé</option>
                                        <option value="refusé">Refusé</option>
                                        <option value="en_cours_traitement">En cours de traitement</option>
                                        <option value="expédié">Expédié</option>
                                        <option value="clôturé">Clôturé</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="ticket-priority">Priorité <i class="fas fa-info-circle help-icon" title="Détermine l'urgence du traitement du ticket"></i></label>
                                    <span class="current-value-indicator">Priorité actuelle: <span id="visible-current-priority"></span></span>
                                    <small class="help-text">Aide à organiser le traitement des demandes par ordre d'importance (non visible par le client)</small>
                                    <select id="ticket-priority">
                                        <option value="">Conserver la priorité actuelle</option>
                                        <option value="faible">Faible</option>
                                        <option value="moyen">Moyenne</option>
                                        <option value="élevé">Élevée</option>
                                        <option value="urgent">Urgente</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="response-template">Modèle de réponse <i class="fas fa-info-circle help-icon" title="Insère un modèle avec des variables comme le nom du client"></i></label>
                                    <small class="help-text">Choisissez un modèle pour accélérer votre réponse</small>
                                    <select id="response-template">
                                        <option value="">Aucun modèle</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="status-comment">Commentaire <i class="fas fa-info-circle help-icon" title="Visible par le client dans le suivi du ticket"></i></label>
                                    <small class="help-text">Ce commentaire sera visible par le client et lui explique le changement de statut</small>
                                    <textarea id="status-comment" rows="3"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="comment-attachments">Pièces jointes</label>
                                    <small class="help-text">Ajoutez des fichiers (JPG, PNG, PDF)</small>
                                    <input type="file" id="comment-attachments" accept=".jpg,.jpeg,.png,.pdf" multiple>
                                    <div id="comment-attachments-preview" class="attachments-preview" style="display:none; margin-top:8px;"></div>
                                </div>
                                <div class="form-group" id="additional-info-group" style="display: none;">
                                    <label for="additional-info">Informations complémentaires demandées <i class="fas fa-info-circle help-icon" title="Précisez les documents ou informations nécessaires au client"></i></label>
                                    <small class="help-text">Détaillez précisément les informations manquantes pour traiter le dossier</small>
                                    <textarea id="additional-info" rows="3"></textarea>
                                </div>
                                <div class="form-group">
                                    <label class="checkbox-container" title="Envoie un email automatique au client pour l'informer du changement">
                                        <input type="checkbox" id="notify-client" checked>
                                        <span class="checkmark"></span>
                                        Notifier le client par email <i class="fas fa-info-circle help-icon" title="Un email automatique sera envoyé avec le nouveau statut et commentaire"></i>
                                    </label>
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn-primary" title="Enregistrer les modifications et mettre à jour le ticket">Mettre à jour</button>
                                    <small class="help-text btn-help">Les modifications seront immédiatement enregistrées et le client sera notifié si l'option est sélectionnée</small>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                </div> <!-- Fin ticket-details -->
            </main>
        </div>
</div>
    
    <!-- UI Containers for custom modal and toasts -->
    <div id="cpf-modal-root" style="display:none;"></div>
    <!-- Turndown: HTML -> Markdown conversion for WYSIWYG saving -->
    <script src="https://cdn.jsdelivr.net/npm/turndown@7.1.2/dist/turndown.js"></script>
    <div id="cpf-toast-container" class="cpf-toast-container"></div>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="admin.js?v=20250809-1"></script>
    <script src="kanban.js?v=20250809-1"></script>
</body>
</html>
